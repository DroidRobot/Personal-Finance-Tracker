// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User and Authentication
model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String?
  firstName         String
  lastName          String
  avatarUrl         String?
  emailVerified     Boolean   @default(false)
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // OAuth
  oauthProviders    OAuthProvider[]
  
  // Relations
  accounts          Account[]
  transactions      Transaction[]
  budgets           Budget[]
  categories        Category[]
  recurringPayments RecurringPayment[]
  goals             Goal[]
  notifications     Notification[]
  sessions          Session[]
  refreshTokens     RefreshToken[]
  
  @@index([email])
}

model OAuthProvider {
  id         String   @id @default(cuid())
  provider   String   // google, github, etc.
  providerId String
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  
  @@unique([provider, providerId])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

// Financial Accounts
model Account {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name              String
  type              AccountType
  institution       String?
  accountNumber     String?   // Last 4 digits only
  balance           Decimal   @db.Decimal(12, 2)
  currency          String    @default("USD")
  isActive          Boolean   @default(true)
  
  // Plaid Integration
  plaidAccountId    String?   @unique
  plaidAccessToken  String?   // Encrypted
  plaidItemId       String?
  lastSyncAt        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  transactions      Transaction[]
  
  @@index([userId])
  @@index([plaidAccountId])
}

enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  INVESTMENT
  LOAN
  MORTGAGE
  OTHER
}

// Transactions
model Transaction {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId       String
  account         Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  amount          Decimal   @db.Decimal(12, 2)
  currency        String    @default("USD")
  type            TransactionType
  status          TransactionStatus @default(POSTED)
  
  description     String
  merchantName    String?
  categoryId      String?
  category        Category? @relation(fields: [categoryId], references: [id])
  
  date            DateTime
  notes           String?
  tags            String[]
  
  // Receipt scanning
  receiptUrl      String?
  receiptOcrData  Json?
  
  // Plaid data
  plaidTransactionId String? @unique
  plaidPending    Boolean   @default(false)
  
  // Tax tracking
  taxDeductible   Boolean   @default(false)
  taxCategory     String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([accountId])
  @@index([categoryId])
  @@index([date])
  @@index([plaidTransactionId])
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum TransactionStatus {
  PENDING
  POSTED
  CANCELLED
}

// Categories
model Category {
  id            String    @id @default(cuid())
  userId        String?
  user          User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  icon          String?
  color         String?
  type          TransactionType
  parentId      String?
  parent        Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[] @relation("CategoryHierarchy")
  
  isSystem      Boolean   @default(false) // System-wide categories
  isActive      Boolean   @default(true)
  
  transactions  Transaction[]
  budgets       Budget[]
  
  @@unique([userId, name])
  @@index([userId])
  @@index([parentId])
}

// Budgets
model Budget {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  amount        Decimal   @db.Decimal(12, 2)
  period        BudgetPeriod
  startDate     DateTime
  endDate       DateTime?
  
  categoryId    String?
  category      Category? @relation(fields: [categoryId], references: [id])
  
  rollover      Boolean   @default(false)
  alertEnabled  Boolean   @default(true)
  alertThreshold Int       @default(80) // Percentage
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([userId])
  @@index([categoryId])
  @@index([startDate, endDate])
}

enum BudgetPeriod {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  CUSTOM
}

// Recurring Payments
model RecurringPayment {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String
  amount          Decimal   @db.Decimal(12, 2)
  frequency       RecurrenceFrequency
  nextDueDate     DateTime
  
  merchantName    String?
  categoryId      String?
  accountId       String?
  
  isActive        Boolean   @default(true)
  autoDetected    Boolean   @default(false)
  reminderEnabled Boolean   @default(true)
  reminderDays    Int       @default(3) // Days before due date
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([nextDueDate])
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

// Financial Goals
model Goal {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  description   String?
  targetAmount  Decimal   @db.Decimal(12, 2)
  currentAmount Decimal   @db.Decimal(12, 2) @default(0)
  targetDate    DateTime
  
  icon          String?
  color         String?
  
  isAchieved    Boolean   @default(false)
  achievedAt    DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([userId])
  @@index([targetDate])
}

// Notifications
model Notification {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  title       String
  message     String
  data        Json?
  
  isRead      Boolean   @default(false)
  readAt      DateTime?
  
  createdAt   DateTime  @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  BUDGET_ALERT
  BILL_REMINDER
  GOAL_MILESTONE
  UNUSUAL_SPENDING
  LOW_BALANCE
  NEW_TRANSACTION
  SYNC_ERROR
  SYSTEM
}
